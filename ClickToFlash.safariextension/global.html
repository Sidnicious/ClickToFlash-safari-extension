<!DOCTYPE html>
<html>
	<head>
		<title>Global HTML</title>
		<script type="text/javascript">
			function checkIfURLExists(event) {
				var args = event.message;
				var URL = args.url;
				
				var req = new XMLHttpRequest();
				req.open("HEAD", URL, true);

				req.onreadystatechange = function() {
					if (req.readyState == 3) {
						// XMLHttpRequest bug: If redirected from
						// a HEAD request, it does a GET on the final
						// destination.
						
						// We don't want to download the entire video,
						// so this is a workaround that should
						// hopefully work.
						
						// If we're downloading data, that means the
						// video exists.
						req.abort();
					} else if (req.readyState == 4) {
						args.exists = (req.status == 200 ? true : false);
						event.target.page.dispatchMessage("getURLExists", args);
					}
				};
				req.send(null);
			}
			
			function getSettings(event) {
				var settings = new Object();
				settings.useH264 = safari.extension.settings["useH264"];
				settings.useLargeH264 = safari.extension.settings["useLargeH264"];
				
				event.target.page.dispatchMessage("getSettings", settings);
			}
			
			function respondToMessage(event) {
				if (event.name == "checkIfURLExists") {
					checkIfURLExists(event);
				} else if (event.name == "getSettings") {
					getSettings(event);
				}
			}
			
			safari.application.addEventListener("message", respondToMessage, false);
		</script>
	</head>
	<body></body>
<html>